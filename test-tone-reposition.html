<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tone Repositioning</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-case.pass {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .test-case.fail {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        h1 {
            color: #333;
        }
        .result {
            font-weight: bold;
            margin-top: 10px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Tone Repositioning Logic</h1>
    <div id="test-results"></div>

    <script src="univiet-core.js"></script>
    <script>
        const univiet = new UniVietCore();
        const resultsDiv = document.getElementById('test-results');

        function testSequence(keys, expectedResult, description) {
            let word = '';
            let result = '';

            for (let i = 0; i < keys.length; i++) {
                const key = keys[i];
                const processResult = univiet.processKey(word, key);

                if (processResult && processResult.shouldReplace) {
                    if (processResult.replaceAt !== undefined) {
                        // Replace at specific position
                        const replacePos = word.length - processResult.replaceAt - 1;
                        word = word.substring(0, replacePos) + processResult.text + word.substring(replacePos + 1);
                    } else if (processResult.deleteCount) {
                        // Delete and add
                        const deleteStart = word.length - processResult.deleteCount;
                        word = word.substring(0, deleteStart) + processResult.text;
                    } else {
                        // Just add
                        word = word + processResult.text;
                    }
                } else {
                    // Normal character
                    word = word + key;
                }

                result += `${word} `;
            }

            const passed = word === expectedResult;
            const testCase = document.createElement('div');
            testCase.className = `test-case ${passed ? 'pass' : 'fail'}`;
            testCase.innerHTML = `
                <strong>${description}</strong><br>
                Input: <code>${keys.join('')}</code><br>
                Expected: <code>${expectedResult}</code><br>
                Got: <code>${word}</code><br>
                Steps: ${result}<br>
                <div class="result">${passed ? '‚úÖ PASS' : '‚ùå FAIL'}</div>
            `;
            resultsDiv.appendChild(testCase);

            return passed;
        }

        // Run tests
        console.log('Running Tone Repositioning Tests...');

        const tests = [
            {
                keys: ['h', 'i', 'f', 'e', 'e', 'n'],
                expected: 'hi·ªÅn',
                description: 'Test 1: hifeen ‚Üí hi·ªÅn (bug ch√≠nh)'
            },
            {
                keys: ['t', 'o', 'f', 'i', 's'],
                expected: 't√≥i',
                description: 'Test 2: tofis ‚Üí t√≥i (2 nguy√™n √¢m + ph·ª• √¢m cu·ªëi)'
            },
            {
                keys: ['t', 'o', 'f', 'i'],
                expected: 't√≤i',
                description: 'Test 3: tofi ‚Üí t√≤i (2 nguy√™n √¢m kh√¥ng ph·ª• √¢m cu·ªëi)'
            },
            {
                keys: ['q', 'u', 'a', 'f', 'e', 'y'],
                expected: 'qu√°y',
                description: 'Test 4: quafey ‚Üí qu√°y (3 nguy√™n √¢m, d·∫•u ·ªü gi·ªØa)'
            },
            {
                keys: ['h', 'o', 'a', 'f', 't'],
                expected: 'ho·∫°t',
                description: 'Test 5: hoaft ‚Üí ho·∫°t (undo d·∫•u cho v·∫ßn oa)'
            },
            {
                keys: ['v', 'i', 'e', 'e', 's', 't'],
                expected: 'vi·ªát',
                description: 'Test 6: vieest ‚Üí vi·ªát (ee ‚Üí √™, d·∫•u s·∫Øc)'
            },
            {
                keys: ['d', 'i', 'e', 'e', 'u', 'f'],
                expected: 'ƒëi·ªÅu',
                description: 'Test 7: dieeuf ‚Üí ƒëi·ªÅu (3 nguy√™n √¢m, dd, d·∫•u huy·ªÅn)'
            },
            {
                keys: ['t', 'h', 'u', 'o', 'o', 'c', 'x'],
                expected: 'thu·ªôc',
                description: 'Test 8: thuoocx ‚Üí thu·ªôc (oo ‚Üí √¥, d·∫•u ng√£)'
            },
            {
                keys: ['c', 'h', 'i', 'e', 'e', 'f', 'n'],
                expected: 'chi·ªÅn',
                description: 'Test 9: chieefn ‚Üí chi·ªÅn (d·∫•u huy·ªÅn sau khi ee)'
            },
            {
                keys: ['n', 'g', 'h', 'i', 'e', 'e', 'r', 'm'],
                expected: 'nghi·ªÉm',
                description: 'Test 10: nghieerm ‚Üí nghi·ªÉm (d·∫•u h·ªèi + ph·ª• √¢m cu·ªëi)'
            }
        ];

        let passed = 0;
        let failed = 0;

        tests.forEach(test => {
            if (testSequence(test.keys, test.expected, test.description)) {
                passed++;
            } else {
                failed++;
            }
        });

        // Summary
        const summary = document.createElement('div');
        summary.style.marginTop = '30px';
        summary.style.padding = '20px';
        summary.style.background = '#f8f9fa';
        summary.style.borderRadius = '5px';
        summary.innerHTML = `
            <h2>üìä Test Summary</h2>
            <p>Total: ${tests.length} tests</p>
            <p style="color: green;">‚úÖ Passed: ${passed}</p>
            <p style="color: red;">‚ùå Failed: ${failed}</p>
        `;
        resultsDiv.appendChild(summary);

        console.log(`Tests completed: ${passed} passed, ${failed} failed`);
    </script>
</body>
</html>
